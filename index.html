<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<title>Leonek Piesek üê∂</title>
<style>
  html, body {
    margin: 0;
    padding: 0;
    background: #0b0b10;
    color: #f3f3f5;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    height: 100%;
    overflow: hidden;
  }
  #ui {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    padding: 8px 12px;
    display: flex;
    align-items: center;
    gap: 8px;
    background: linear-gradient(180deg, rgba(12,12,16,0.9) 0%, rgba(12,12,16,0.6) 100%);
    backdrop-filter: blur(8px);
    z-index: 5;
    flex-wrap: wrap;
  }
  .pill {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 10px;
    border-radius: 999px;
    background: #15151c;
    border: 1px solid #272733;
    font-weight: 600;
    font-size: 14px;
  }
  .bar {
    height: 8px;
    width: 120px;
    background: #242433;
    border-radius: 999px;
    overflow: hidden;
    border: 1px solid #323244;
  }
  .bar > span { display:block; height:100%; width:0%; background:#6ee7b7; }
  .bar.water > span { background:#60a5fa; }
  .bar.food > span { background:#fbbf24; }
  .bar.sleep > span { background:#a78bfa; }
  .bar.mood > span { background:#f472b6; }
  #toast {
    position: fixed;
    left: 50%;
    transform: translateX(-50%);
    bottom: 20px;
    background: #111113;
    color: #fff;
    border: 1px solid #2a2a33;
    border-radius: 10px;
    padding: 10px 14px;
    z-index: 10;
    opacity: 0;
    pointer-events: none;
    transition: opacity .25s ease;
    max-width: 90vw;
    text-align: center;
  }
  #overlay, #profileOverlay {
    position: fixed; inset: 0; background: rgba(0,0,0,.6);
    display: none; align-items: center; justify-content: center; z-index: 20;
  }
  .panel {
    width: min(640px, 92vw);
    background: #121218;
    border: 1px solid #2a2a33;
    border-radius: 14px;
    padding: 16px;
    box-shadow: 0 10px 40px rgba(0,0,0,.45);
  }
  .panel h2 { margin: 6px 0 12px; font-size: 22px; }
  .shop-grid, .profile-grid {
    display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;
  }
  .card {
    background:#191920; border:1px solid #2a2a33; border-radius:12px; padding:12px;
  }
  .card button, .btn {
    padding: 8px 10px; border-radius:10px; border:1px solid #2a2a33;
    background:#0f0f14; color:#fff; font-weight:600;
  }
  .toolbar {
    margin-left: auto; display: inline-flex; gap:8px; flex-wrap: wrap;
  }
  canvas { position: fixed; inset: 0; width: 100vw; height: 100vh; }
  /* On-screen controls */
  #controls {
    position: fixed; left: 10px; bottom: 10px; display: grid; grid-template-columns: 60px 60px 60px; grid-template-rows: 60px 60px 60px; gap: 6px; z-index: 6;
    opacity: .9;
  }
  #controls button {
    width: 60px; height: 60px; border-radius: 12px; border: 1px solid #2a2a33; background: #14141b; color: #fff; font-size: 18px; font-weight: 700;
  }
  #actionBtn {
    position: fixed; right: 10px; bottom: 20px; width: 88px; height: 88px; border-radius: 999px; border:1px solid #2a2a33; background:#14141b; color:#fff; font-weight: 800; z-index: 6;
  }
  @media (min-width:900px) {
    #controls, #actionBtn { display:none; }
  }
  #thoughts {
    font-size: 13px; opacity: .9;
  }
</style>
</head>
<body>
<div id="ui">
  <div class="pill">üßª <span id="coins">0</span></div>
  <div class="pill">üîÅ Runda <span id="round">1</span></div>
  <div class="pill">üåó <span id="dayPhase">Dzie≈Ñ</span></div>
  <div class="pill">
    üíß
    <div class="bar water"><span id="barWater"></span></div>
  </div>
  <div class="pill">
    üçó
    <div class="bar food"><span id="barFood"></span></div>
  </div>
  <div class="pill">
    üí§
    <div class="bar sleep"><span id="barSleep"></span></div>
  </div>
  <div class="pill">
    üòä
    <div class="bar mood"><span id="barMood"></span></div>
  </div>
  <div class="pill" id="thoughts">‚ÄûDzie≈Ñ dobry!‚Äù</div>
  <div class="toolbar">
    <button class="btn" id="btnDominika">Dominika</button>
    <button class="btn" id="btnPet">Pog≈Çaszcz</button>
    <button class="btn" id="btnPlay">Pobaw siƒô</button>
    <button class="btn" id="btnShop">Ulepszenia</button>
    <button class="btn" id="btnProfile">Profil</button>
    <button class="btn" id="btnSave">Zapis</button>
    <button class="btn" id="btnReset">Reset</button>
    <button class="btn" id="btnPause">Pauza</button>
  </div>
</div>

<div id="overlay"><div class="panel" id="dominikaPanel" style="display:none">
  <h2>Dominika üíñ</h2>
  <p>Dom to bezpieczne miejsce. Mo≈ºesz poprosiƒá Dominikƒô o pomoc w zamian za chusteczki. Twoje: <b id="domCoins">0</b></p>
  <div class="shop-grid">
    <div class="card">
      <h3>Woda üíß</h3>
      <p>+35 wody. Cena: 3 üßª</p>
      <button data-dom="water">Popro≈õ</button>
    </div>
    <div class="card">
      <h3>Jedzenie üçó</h3>
      <p>+35 jedzenia. Cena: 3 üßª</p>
      <button data-dom="food">Popro≈õ</button>
    </div>
    <div class="card">
      <h3>KƒÖpiel üõÅ</h3>
      <p>+20 humoru i czysto≈õƒá (symbolicznie).</p>
      <button data-dom="bath">Popro≈õ</button>
    </div>
    <div class="card">
      <h3>Przytulanki üí§</h3>
      <p>Sen +25 i humor +25.</p>
      <button data-dom="snuggle">Popro≈õ</button>
    </div>
  </div>
  <div style="display:flex; gap:8px; margin-top:12px;">
    <button class="btn" id="btnCloseDom">Zamknij</button>
  </div>
</div>

<div class="panel" id="shopPanel" style="display:none">
  <h2>Ulepszenia Leonka</h2>
  <p>Wydaj chusteczki üßª na ma≈Çe ulepszenia (lokalne, bez premium). Twoje: <b id="shopCoins">0</b></p>
  <div class="shop-grid">
    <div class="card">
      <h3>Buty Sprintu</h3>
      <p>Szybszy bieg (+20%).</p>
      <p>Cena: 30 üßª</p>
      <button data-item="sprint">Kup</button>
    </div>
    <div class="card">
      <h3>Miseczka XL</h3>
      <p>Jedzenie spada wolniej (-25%).</p>
      <p>Cena: 25 üßª</p>
      <button data-item="foodSlow">Kup</button>
    </div>
    <div class="card">
      <h3>Butelka Pro</h3>
      <p>Woda spada wolniej (-25%).</p>
      <p>Cena: 25 üßª</p>
      <button data-item="waterSlow">Kup</button>
    </div>
    <div class="card">
      <h3>Podusia 2.0</h3>
      <p>Sen spada wolniej (-25%).</p>
      <p>Cena: 25 üßª</p>
      <button data-item="sleepSlow">Kup</button>
    </div>
  </div>
  <div style="display:flex; gap:8px; margin-top:12px;">
    <button class="btn" id="btnCloseShop">Zamknij</button>
  </div>
</div></div>

<div id="profileOverlay"><div class="panel">
  <h2>Profile</h2>
  <div style="display:flex; gap:8px; margin-bottom:10px;">
    <input id="nickInput" placeholder="Nick" style="flex:1; padding:8px 10px; border-radius:10px; border:1px solid #2a2a33; background:#0f0f14; color:#fff;">
    <button class="btn" id="btnCreateProfile">Utw√≥rz / Wczytaj</button>
  </div>
  <div class="profile-grid" id="profileList"></div>
  <div style="display:flex; gap:8px; margin-top:12px;">
    <button class="btn" id="btnCloseProfile">Zamknij</button>
  </div>
</div></div>

<canvas id="game"></canvas>

<!-- On-screen controls for mobile -->
<div id="controls">
  <div></div><button data-dx="0" data-dy="-1">‚ñ≤</button><div></div>
  <button data-dx="-1" data-dy="0">‚óÄ</button><div></div><button data-dx="1" data-dy="0">‚ñ∂</button>
  <div></div><button data-dx="0" data-dy="1">‚ñº</button><div></div>
</div>
<button id="actionBtn">Sprint</button>

<div id="toast"></div>

<script>
(() => {
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const ui = {
    coins: document.getElementById('coins'),
    round: document.getElementById('round'),
    barWater: document.getElementById('barWater'),
    barFood: document.getElementById('barFood'),
    barSleep: document.getElementById('barSleep'),
    barMood: document.getElementById('barMood'),
    toast: document.getElementById('toast'),
    dayPhase: document.getElementById('dayPhase'),
    thoughts: document.getElementById('thoughts')
  };
  const overlay = document.getElementById('overlay');
  const domPanel = document.getElementById('dominikaPanel');
  const shopPanel = document.getElementById('shopPanel');
  const shopCoinsEl = document.getElementById('shopCoins');
  const domCoinsEl = document.getElementById('domCoins');
  const btnShop = document.getElementById('btnShop');
  const btnCloseShop = document.getElementById('btnCloseShop');
  const btnDominika = document.getElementById('btnDominika');
  const btnCloseDom = document.getElementById('btnCloseDom');
  const btnPause = document.getElementById('btnPause');
  const btnReset = document.getElementById('btnReset');
  const btnSave = document.getElementById('btnSave');
  const btnPet = document.getElementById('btnPet');
  const btnPlay = document.getElementById('btnPlay');

  // Profiles
  const profileOverlay = document.getElementById('profileOverlay');
  const btnProfile = document.getElementById('btnProfile');
  const btnCreateProfile = document.getElementById('btnCreateProfile');
  const btnCloseProfile = document.getElementById('btnCloseProfile');
  const nickInput = document.getElementById('nickInput');
  const profileList = document.getElementById('profileList');

  const keys = new Set();
  const mobileDir = {x:0,y:0};
  const controls = document.getElementById('controls');
  controls.querySelectorAll('button').forEach(b => {
    b.addEventListener('touchstart', e => { e.preventDefault(); mobileDir.x = parseInt(b.dataset.dx); mobileDir.y = parseInt(b.dataset.dy); });
    b.addEventListener('touchend', e => { e.preventDefault(); mobileDir.x = 0; mobileDir.y = 0; });
  });
  const actionBtn = document.getElementById('actionBtn');
  let sprintHeld = false;
  actionBtn.addEventListener('touchstart', e => {e.preventDefault(); sprintHeld = true;});
  actionBtn.addEventListener('touchend', e => {e.preventDefault(); sprintHeld = false;});

  // Resize
  function fit() {
    canvas.width = window.innerWidth * devicePixelRatio;
    canvas.height = window.innerHeight * devicePixelRatio;
    ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
  }
  window.addEventListener('resize', fit);
  fit();

  // Audio
  const AudioCtx = window.AudioContext || window.webkitAudioContext;
  let audioCtx;
  function ensureAudio() {
    if(!audioCtx) audioCtx = new AudioCtx();
  }
  function beep(freq=600, dur=0.1, type='square', gain=0.08) {
    if(!audioCtx) return;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = type; o.frequency.setValueAtTime(freq, audioCtx.currentTime);
    g.gain.value = gain;
    o.connect(g).connect(audioCtx.destination);
    o.start();
    o.stop(audioCtx.currentTime + dur);
  }
  function shout() {
    if(!audioCtx) return;
    const dur = 0.18;
    const sampleRate = audioCtx.sampleRate;
    const buffer = audioCtx.createBuffer(1, sampleRate * dur, sampleRate);
    const data = buffer.getChannelData(0);
    for (let i=0;i<data.length;i++) data[i] = (Math.random()*2-1) * (1 - i/data.length);
    const src = audioCtx.createBufferSource(); src.buffer = buffer;
    const g = audioCtx.createGain(); g.gain.value = 0.1;
    src.connect(g).connect(audioCtx.destination);
    src.start();
  }

  // Haptics
  function haptic(ms=40) {
    if (navigator.vibrate) navigator.vibrate(ms);
    screenShake = Math.max(screenShake, 10);
  }

  // --- Profiles & Persistence ---
  const SAVE_ROOT = 'leonek_profiles_v1';
  function listProfiles() {
    try {
      const d = JSON.parse(localStorage.getItem(SAVE_ROOT)) || {list:[]};
      return d.list;
    } catch { return []; }
  }
  function saveProfileList(list) {
    localStorage.setItem(SAVE_ROOT, JSON.stringify({list}));
  }
  function profileKey(nick) { return `leonek_${nick}_save`; }
  function loadSave(nick) {
    try { return JSON.parse(localStorage.getItem(profileKey(nick))) || null; } catch { return null; }
  }
  function saveNow() {
    if (!state.nick) return toast('Wybierz profil w ‚ÄûProfil‚Äù.');
    localStorage.setItem(profileKey(state.nick), JSON.stringify({
      coins, round, upgrades, meters, mood, timeOfDay, worldSeed
    }));
    toast('Zapisano ‚úÖ');
  }
  function resetSave() {
    if (state.nick) localStorage.removeItem(profileKey(state.nick));
    document.location.reload();
  }

  function refreshProfileList() {
    profileList.innerHTML = '';
    listProfiles().forEach(n => {
      const div = document.createElement('div');
      div.className = 'card';
      div.innerHTML = `<b>${n}</b><br><button data-load="${n}">Wczytaj</button> <button data-del="${n}">Usu≈Ñ</button>`;
      profileList.appendChild(div);
    });
    profileList.querySelectorAll('button[data-load]').forEach(b => {
      b.onclick = () => { useProfile(b.dataset.load); };
    });
    profileList.querySelectorAll('button[data-del]').forEach(b => {
      b.onclick = () => {
        const n = b.dataset.del;
        localStorage.removeItem(profileKey(n));
        const arr = listProfiles().filter(x=>x!==n);
        saveProfileList(arr);
        refreshProfileList();
      };
    });
  }

  function useProfile(nick) {
    state.nick = nick;
    const saved = loadSave(nick);
    if (saved) {
      coins = saved.coins||0;
      round = Math.min(saved.round||1, maxRounds);
      Object.assign(upgrades, saved.upgrades||{});
      Object.assign(meters, saved.meters||{});
      mood = saved.mood ?? 80;
      timeOfDay = saved.timeOfDay ?? 0.2;
      worldSeed = saved.worldSeed ?? Math.random()*1e9|0;
    } else {
      coins = 0; round = 1; Object.assign(meters, {water:100, food:100, sleep:100}); mood = 80;
      worldSeed = Math.random()*1e9|0;
    }
    ui.coins.textContent = coins;
    ui.round.textContent = round;
    spawnLevel();
    profileOverlay.style.display = 'none';
    toast(`Profil: ${nick} ‚úÖ`);
  }

  btnProfile.onclick = () => { profileOverlay.style.display='flex'; refreshProfileList(); };
  btnCreateProfile.onclick = () => {
    const n = (nickInput.value||'').trim().slice(0,16);
    if (!n) return;
    const set = new Set(listProfiles());
    if (!set.has(n)) {
      const arr = [...set, n];
      saveProfileList(arr);
    }
    useProfile(n);
  };
  btnCloseProfile.onclick = () => { profileOverlay.style.display='none'; };

  // Game state
  const state = { nick: null };
  let coins = 0;
  let round = 1;
  const maxRounds = 6;
  let paused = false;
  let screenShake = 0;
  let timeOfDay = 0.2; // 0..1 (0=noc, 0.25=≈õwit, 0.5=dzie≈Ñ, 0.75=zmierzch)
  let mood = 80; // 0..100
  let worldSeed = Math.random()*1e9|0;

  const meters = { water: 100, food: 100, sleep: 100 };
  const baseDrain = { water: .9, food: .7, sleep: .5 }; // per 10s
  const upgrades = { sprint:false, waterSlow:false, foodSlow:false, sleepSlow:false };

  function srand(seed){ return function(){ seed = (seed*1664525 + 1013904223) % 4294967296; return seed/4294967296; } }
  let rnd = srand(worldSeed);

  // Levels
  const levels = Array.from({length:maxRounds}).map((_,i)=>{
    const size = 26 + i*6;
    return {
      width: size,
      height: size,
      enemies: 2 + i,
      tissues: 10 + i*4,
      badZones: 2 + i,
      needed: 8 + i*3,
      pickups: 3 + i,
      timeLimit: 90 - i*5
    };
  });

  function tile() { return Math.floor(Math.min(canvas.width, canvas.height) / 24); }

  // Map with designated "home" and "doghouse" areas
  function makeMap(w,h) {
    const grid = Array.from({length:h}, ()=>Array.from({length:w}, ()=>0));
    for(let x=0;x<w;x++){ grid[0][x]=1; grid[h-1][x]=1; }
    for(let y=0;y<h;y++){ grid[y][0]=1; grid[y][w-1]=1; }
    const blocks = Math.floor((w*h)*0.08);
    for(let i=0;i<blocks;i++){
      const x = 1 + Math.floor(rnd()*(w-2));
      const y = 1 + Math.floor(rnd()*(h-2));
      grid[y][x] = 1;
    }
    return grid;
  }

  // Entities & world
  const world = {
    w: levels[round-1].width,
    h: levels[round-1].height,
    grid: null,
    tissues: [],
    pickups: [],
    enemies: [],
    badZones: [],
    player: { x:2, y:2, vx:0, vy:0, spd: 5, r: 0.38, anim: 0 },
    home: {x:0,y:0,r:2},
    doghouse: {x:0,y:0,r:1.6}
  };

  function isFree(x,y) { return world.grid[y] && world.grid[y][x] === 0; }

  function randFree() {
    let tries = 0;
    while (tries++ < 999) {
      const x = 1 + Math.floor(rnd()*(world.w-2));
      const y = 1 + Math.floor(rnd()*(world.h-2));
      if (isFree(x,y)) return {x,y};
    }
    return {x:2,y:2};
  }

  function place(arr, type, count) {
    for(let i=0;i<count;i++){
      const p = randFree();
      if (type==='tissue') world.tissues.push(p);
      if (type==='pickup') {
        const types = ['water','food','sleep'];
        world.pickups.push({x:p.x,y:p.y,type:types[Math.floor(rnd()*types.length)]});
      }
      if (type==='enemy') world.enemies.push({x:p.x,y:p.y, vx:0, vy:0, r:0.42, aggro: 0});
      if (type==='zone') world.badZones.push({x:p.x, y:p.y, r: 1.2, t: 0});
    }
  }

  let goalCollected = 0;
  let timeLeft = levels[0].timeLimit;

  function spawnLevel() {
    rnd = srand(worldSeed + round*97);
    const L = levels[round-1];
    world.w = L.width; world.h = L.height;
    world.grid = makeMap(world.w, world.h);
    world.tissues = []; world.pickups = []; world.enemies = []; world.badZones = [];
    // player
    world.player.x = 2; world.player.y = 2; world.player.vx = 0; world.player.vy = 0;
    // points of interest
    world.home = randFree();
    world.home.r = 2.2;
    world.doghouse = randFree();
    world.doghouse.r = 1.6;
    // items & enemies
    place(null,'tissue', L.tissues);
    place(null,'pickup', L.pickups);
    place(null,'enemy', L.enemies);
    place(null,'zone', L.badZones);
    goalCollected = 0;
    timeLeft = L.timeLimit;
  }

  function toast(msg) {
    ui.toast.textContent = msg;
    ui.toast.style.opacity = 1;
    clearTimeout(toast._t);
    toast._t = setTimeout(()=> ui.toast.style.opacity = 0, 1600);
  }

  // Controls
  window.addEventListener('keydown', e => {
    ensureAudio();
    keys.add(e.key.toLowerCase());
    if (e.key === 'p') togglePause();
    if ([' ','shift'].includes(e.key.toLowerCase())) sprintHeld = true;
  });
  window.addEventListener('keyup', e => {
    keys.delete(e.key.toLowerCase());
    if ([' ','shift'].includes(e.key.toLowerCase())) sprintHeld = false;
  });

  function dirInput() {
    let x = 0, y = 0;
    if (keys.has('arrowup') || keys.has('w')) y -= 1;
    if (keys.has('arrowdown') || keys.has('s')) y += 1;
    if (keys.has('arrowleft') || keys.has('a')) x -= 1;
    if (keys.has('arrowright') || keys.has('d')) x += 1;
    if (!x && !y) { x = mobileDir.x; y = mobileDir.y; }
    const len = Math.hypot(x,y)||1;
    return {x:x/len, y:y/len};
  }

  function togglePause() {
    paused = !paused;
    toast(paused ? 'Pauza ‚è∏' : 'Gramy ‚ñ∂Ô∏è');
  }
  btnPause.onclick = togglePause;
  btnReset.onclick = resetSave;
  btnSave.onclick = saveNow;

  // Dominika panel
  btnDominika.onclick = () => {
    if (!inHome()) return toast('Dominika jest w domu üè† ‚Äî wejd≈∫ do domu!');
    domCoinsEl.textContent = coins;
    shopPanel.style.display='none';
    domPanel.style.display='block';
    overlay.style.display='flex';
    paused = true;
  };
  btnCloseDom.onclick = () => { overlay.style.display='none'; domPanel.style.display='none'; paused=false; };

  overlay.addEventListener('click', (e) => {
    if (e.target === overlay) { overlay.style.display='none'; domPanel.style.display='none'; shopPanel.style.display='none'; paused=false; }
  });

  // Shop (upgrades)
  btnShop.onclick = () => { shopCoinsEl.textContent = coins; shopPanel.style.display='block'; domPanel.style.display='none'; overlay.style.display='flex'; paused = true; };
  btnCloseShop.onclick = () => { overlay.style.display='none'; shopPanel.style.display='none'; paused = false; };
  shopPanel.querySelectorAll('button[data-item]').forEach(b => {
    b.addEventListener('click', () => {
      const costs = { sprint:30, foodSlow:25, waterSlow:25, sleepSlow:25 };
      const names = { sprint:'Buty Sprintu', foodSlow:'Miseczka XL', waterSlow:'Butelka Pro', sleepSlow:'Podusia 2.0' };
      const key = b.dataset.item;
      if (upgrades[key]) return toast('Ju≈º masz: ' + names[key]);
      const price = costs[key];
      if (coins < price) return toast('Za ma≈Ço üßª');
      coins -= price; upgrades[key] = true; shopCoinsEl.textContent = coins; ui.coins.textContent = coins;
      beep(800, .09, 'sine', .06);
      toast('Kupiono: ' + names[key]);
    });
  });

  // Dominika actions
  domPanel.querySelectorAll('button[data-dom]').forEach(b => {
    b.addEventListener('click', () => {
      const what = b.dataset.dom;
      if (what==='water' || what==='food') {
        if (coins < 3) return toast('Za ma≈Ço üßª na pro≈õbƒô.');
        coins -= 3; ui.coins.textContent = coins; domCoinsEl.textContent = coins;
        if (what==='water') meters.water = Math.min(100, meters.water + 35);
        if (what==='food')  meters.food  = Math.min(100, meters.food  + 35);
        mood = Math.min(100, mood + 10);
        beep(520,.06,'triangle',.05);
        ui.thoughts.textContent = '‚ÄûDziƒôkujƒô Dominiko!‚Äù';
      } else if (what==='bath') {
        mood = Math.min(100, mood + 20);
        beep(700,.05,'sine',.05);
        ui.thoughts.textContent = '‚ÄûAle czysto!‚Äù';
      } else if (what==='snuggle') {
        meters.sleep = Math.min(100, meters.sleep + 25);
        mood = Math.min(100, mood + 25);
        ui.thoughts.textContent = '‚ÄûKocham Dominikƒô üíñ‚Äù';
        beep(660,.06,'sine',.05);
      }
    });
  });

  // Pet & Play
  btnPet.onclick = () => { mood = Math.min(100, mood + 8); ui.thoughts.textContent='‚ÄûMizi mizi üêæ‚Äù'; beep(760,.05,'sine',.04); };
  btnPlay.onclick = () => { mood = Math.min(100, mood + 12); ui.thoughts.textContent='‚ÄûPi≈Çeczka! Pi≈Çeczka!‚Äù'; beep(880,.06,'triangle',.05); };

  // Helpers
  function blocked(nx, ny, r) {
    const tiles = [
      [Math.floor(nx-r), Math.floor(ny-r)],
      [Math.floor(nx+r), Math.floor(ny-r)],
      [Math.floor(nx-r), Math.floor(ny+r)],
      [Math.floor(nx+r), Math.floor(ny+r)],
    ];
    return tiles.some(([tx,ty]) => world.grid[ty]?.[tx] === 1);
  }

  function inCircle(obj, x, y) {
    const d = Math.hypot(obj.x - x, obj.y - y);
    return d < obj.r;
  }
  function inHome() { return inCircle(world.home, world.player.x, world.player.y); }
  function inDoghouse() { return inCircle(world.doghouse, world.player.x, world.player.y); }

  // Enemy AI (simple)
  function updateEnemies(dt) {
    world.enemies.forEach(e => {
      const dx = world.player.x - e.x;
      const dy = world.player.y - e.y;
      const dist = Math.hypot(dx,dy);
      const speed = dist < 5 ? 2.8 : 1.2;
      if (dist < 6) e.aggro = Math.min(1, e.aggro + dt*1.5); else e.aggro = Math.max(0, e.aggro - dt*0.6);
      const nx = e.x + (dx/dist||0) * speed * dt * (0.6 + e.aggro*0.8);
      const ny = e.y + (dy/dist||0) * speed * dt * (0.6 + e.aggro*0.8);
      if (!blocked(nx, e.y, e.r)) e.x = nx;
      if (!blocked(e.x, ny, e.r)) e.y = ny;

      // Shout if very close
      if (dist < 2.2 && Math.random()<0.02) {
        shout(); haptic(25); drainAll(1.5);
        mood = Math.max(0, mood - 8);
        ui.thoughts.textContent = '‚ÄûNie krzycz! üò¢‚Äù';
      }
      if (dist < e.r + world.player.r) { drainAll(9*dt); mood = Math.max(0, mood - 12*dt); screenShake = Math.max(screenShake, 6); haptic(35); }
    });
  }

  function drainAll(amt) {
    meters.water = Math.max(0, meters.water - amt*(upgrades.waterSlow?0.75:1));
    meters.food  = Math.max(0, meters.food  - amt*(upgrades.foodSlow?0.75:1));
    meters.sleep = Math.max(0, meters.sleep - amt*(upgrades.sleepSlow?0.75:1));
  }

  // Misbehavior if low on tissues or low mood
  function obedienceFactor() {
    const need = Math.max(0, 5 - coins); // below 5 tissues => more self-willed
    const moodLack = Math.max(0, 50 - mood)/50;
    return Math.max(0, 1 - (need*0.06 + moodLack*0.3)); // 0..1 (1=obedient)
  }

  // Update
  let lastTime = performance.now();
  function update(dt) {
    if (paused) return;

    // Day/Night cycle
    timeOfDay = (timeOfDay + dt/80) % 1; // full cycle ~80s
    const phase = timeOfDay;
    ui.dayPhase.textContent = phase<0.2?'Noc': phase<0.35?'≈öwit': phase<0.75?'Dzie≈Ñ':'Zmierzch';

    // Meter drain over time
    const t10 = dt / 10;
    meters.water = Math.max(0, meters.water - baseDrain.water * t10 * (upgrades.waterSlow?0.75:1));
    meters.food  = Math.max(0, meters.food  - baseDrain.food  * t10 * (upgrades.foodSlow?0.75:1));
    meters.sleep = Math.max(0, meters.sleep - baseDrain.sleep * t10 * (upgrades.sleepSlow?0.75:1));

    // Mood trends
    mood = Math.max(0, Math.min(100, mood + (inHome()? +6*dt : 0) + (inDoghouse()? -8*dt : 0)));

    // Sleep effects in doghouse
    if (inDoghouse()) {
      meters.sleep = Math.min(100, meters.sleep + 10*dt);
      ui.thoughts.textContent = '‚ÄûBuda‚Ä¶ trochƒô smutno üòï‚Äù';
    }

    // Game over if any 0
    if (meters.water<=0 || meters.food<=0 || meters.sleep<=0) {
      toast('Leonek pad≈Ç ze zmƒôczenia üò¥ / pragnienia üíß / g≈Çodu üçó');
      round = 1; coins = 0;
      Object.assign(meters, {water:100,food:100,sleep:100}); mood = 70;
      Object.keys(upgrades).forEach(k => upgrades[k]=false);
      spawnLevel();
      return;
    }

    // Player movement with misbehavior
    const dir = dirInput();
    let obey = obedienceFactor();
    let dx = dir.x, dy = dir.y;
    if (Math.random() > obey && (dx||dy)) {
      // ignore or randomize a bit
      if (Math.random()<0.5) { dx = 0; dy = 0; ui.thoughts.textContent='‚ÄûNie chcƒô! Potrzebujƒô üßª‚Äù'; }
      else { const a = Math.atan2(dy,dx) + (Math.random()*1.6-0.8); dx = Math.cos(a); dy = Math.sin(a); ui.thoughts.textContent='‚ÄûSam p√≥jdƒô! üôÉ‚Äù'; }
    }
    const spd = (upgrades.sprint || sprintHeld) ? world.player.spd*1.2 : world.player.spd;
    let nx = world.player.x + dx * spd * dt;
    let ny = world.player.y + dy * spd * dt;
    if (!blocked(nx, world.player.y, world.player.r)) world.player.x = nx;
    if (!blocked(world.player.x, ny, world.player.r)) world.player.y = ny;
    world.player.anim += dt * (Math.abs(dx)+Math.abs(dy) > 0.1 ? 6 : 2);

    // Collect tissues
    for (let i=world.tissues.length-1;i>=0;i--) {
      const t = world.tissues[i];
      if (Math.hypot(t.x - world.player.x, t.y - world.player.y) < 0.8) {
        world.tissues.splice(i,1);
        coins += 1; ui.coins.textContent = coins; goalCollected += 1; beep(880,.06,'sine',.04);
        ui.thoughts.textContent = '‚Äûüßª moja!‚Äù';
      }
    }
    // Pickups
    for (let i=world.pickups.length-1;i>=0;i--) {
      const p = world.pickups[i];
      if (Math.hypot(p.x - world.player.x, p.y - world.player.y) < 0.8) {
        world.pickups.splice(i,1);
        if (p.type==='water') meters.water = Math.min(100, meters.water + 25);
        if (p.type==='food')  meters.food  = Math.min(100, meters.food  + 25);
        if (p.type==='sleep') meters.sleep = Math.min(100, meters.sleep + 25);
        beep(520,.05,'triangle',.05);
        ui.thoughts.textContent = p.type==='water' ? '‚Äû≈Åyk wody üíß‚Äù' : p.type==='food' ? '‚ÄûMniam üçó‚Äù' : '‚ÄûDrzemka üí§‚Äù';
      }
    }

    // Enemies
    updateEnemies(dt);

    // Bad zones drain slowly and shout sometimes
    world.badZones.forEach(z => {
      const d = Math.hypot(z.x - world.player.x, z.y - world.player.y);
      if (d < z.r + 0.6) {
        drainAll(3*dt);
        if (Math.random() < 0.01) { shout(); haptic(20); mood = Math.max(0, mood - 5); ui.thoughts.textContent='‚ÄûA≈Ça‚Ä¶ g≈Ço≈õno‚Äù'; }
      }
    });

    // Progress
    timeLeft -= dt;
    if (goalCollected >= levels[round-1].needed) nextRound();
    if (timeLeft <= 0) {
      toast('Czas minƒÖ≈Ç! ‚è∞');
      screenShake = Math.max(screenShake, 12); haptic(50);
      spawnLevel();
    }

    // UI bars
    ui.barWater.style.width = meters.water + '%';
    ui.barFood.style.width = meters.food + '%';
    ui.barSleep.style.width = meters.sleep + '%';
    ui.barMood.style.width  = mood + '%';

    // Screen shake decay
    screenShake = Math.max(0, screenShake - dt*20);
  }

  function nextRound() {
    if (round < maxRounds) {
      round += 1;
      toast('Runda ' + round + ' ‚ñ∂Ô∏è');
      ui.round.textContent = round;
      spawnLevel();
    } else {
      toast('Wygrana! üèÜ');
      coins += 20; ui.coins.textContent = coins;
      round = 1; spawnLevel();
    }
  }

  // Render helpers
  function drawBeagle(x, y, r, animPhase=0, facingX=1) {
    const T = tile();
    const px = x*T, py = y*T;
    ctx.save();
    ctx.translate(px, py);
    ctx.scale(facingX, 1);
    const wag = Math.sin(animPhase*6)*0.2;
    // shadow
    ctx.fillStyle = 'rgba(0,0,0,0.3)';
    ctx.beginPath(); ctx.ellipse(0, r*T*0.9, r*T*1.1, r*T*0.35, 0, 0, Math.PI*2); ctx.fill();
    // body
    ctx.fillStyle = '#8b5a2b';
    ctx.beginPath(); ctx.ellipse(0, 0, r*T*1.2, r*T*0.9, 0, 0, Math.PI*2); ctx.fill();
    // chest (white)
    ctx.fillStyle = '#eee';
    ctx.beginPath(); ctx.ellipse(-r*T*0.2, r*T*0.1, r*T*0.5, r*T*0.4, 0, 0, Math.PI*2); ctx.fill();
    // head
    ctx.fillStyle = '#8b5a2b';
    ctx.beginPath(); ctx.ellipse(r*T*0.9, -r*T*0.1, r*T*0.6, r*T*0.6, 0, 0, Math.PI*2); ctx.fill();
    // ear
    ctx.fillStyle = '#3b2b1a';
    ctx.beginPath(); ctx.ellipse(r*T*1.0, -r*T*0.4, r*T*0.25, r*T*0.45, 0, 0, Math.PI*2); ctx.fill();
    // tail wag
    ctx.save();
    ctx.translate(-r*T*1.1, -r*T*0.2);
    ctx.rotate(wag);
    ctx.fillStyle = '#eee';
    ctx.fillRect(-r*T*0.1, -r*T*0.1, r*T*0.8, r*T*0.2);
    ctx.restore();
    // eye
    ctx.fillStyle = '#000';
    ctx.beginPath(); ctx.arc(r*T*1.15, -r*T*0.2, r*T*0.09, 0, Math.PI*2); ctx.fill();
    ctx.restore();
  }

  function render() {
    const T = tile();
    const cx = Math.max(0, Math.min(world.w*T - canvas.width, world.player.x*T - canvas.width/2));
    const cy = Math.max(0, Math.min(world.h*T - canvas.height, world.player.y*T - canvas.height/2));
    const sx = (Math.random()-0.5) * screenShake;
    const sy = (Math.random()-0.5) * screenShake;

    ctx.save();
    ctx.translate(-(cx - sx), -(cy - sy));

    // base ground with day/night tint
    const skyTint = (timeOfDay<0.5) ? (timeOfDay*2) : (2 - timeOfDay*2); // 0..1..0
    ctx.fillStyle = `rgb(${10+Math.floor(30*skyTint)},${10+Math.floor(35*skyTint)},${13+Math.floor(25*skyTint)})`;
    ctx.fillRect(0,0,world.w*T, world.h*T);

    // tiles
    for(let y=0;y<world.h;y++){
      for(let x=0;x<world.w;x++){
        if (world.grid[y][x]===1) {
          ctx.fillStyle = '#163a1a';
          ctx.fillRect(x*T, y*T, T, T);
          ctx.strokeStyle = '#215527';
          ctx.strokeRect(x*T+0.5, y*T+0.5, T-1, T-1);
        } else {
          ctx.fillStyle = (x+y)%2 ? '#0e1410' : '#0d120f';
          ctx.fillRect(x*T, y*T, T, T);
        }
      }
    }

    // home (house)
    ctx.fillStyle = '#334155';
    ctx.beginPath(); ctx.arc(world.home.x*T, world.home.y*T, world.home.r*T, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle = '#cbd5e1';
    ctx.fillText('üè† DOM', world.home.x*T - T*0.9, world.home.y*T - T*1.1);

    // doghouse
    ctx.fillStyle = '#6b4226';
    ctx.beginPath(); ctx.arc(world.doghouse.x*T, world.doghouse.y*T, world.doghouse.r*T, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle = '#fde68a';
    ctx.fillText('üê∂ BUDA', world.doghouse.x*T - T*0.9, world.doghouse.y*T - T*1.1);

    // bad zones
    world.badZones.forEach(z => {
      ctx.fillStyle = 'rgba(200,50,50,0.08)';
      ctx.beginPath(); ctx.arc(z.x*T, z.y*T, z.r*T, 0, Math.PI*2); ctx.fill();
      ctx.strokeStyle = 'rgba(200,50,50,0.35)'; ctx.setLineDash([8,8]);
      ctx.beginPath(); ctx.arc(z.x*T, z.y*T, z.r*T, 0, Math.PI*2); ctx.stroke();
      ctx.setLineDash([]);
    });

    // tissues
    world.tissues.forEach(t => {
      ctx.fillStyle = '#e5e7eb';
      ctx.beginPath();
      ctx.moveTo(t.x*T - T*0.2, t.y*T - T*0.1);
      ctx.lineTo(t.x*T + T*0.2, t.y*T - T*0.1);
      ctx.lineTo(t.x*T + T*0.15, t.y*T + T*0.1);
      ctx.lineTo(t.x*T - T*0.15, t.y*T + T*0.1);
      ctx.closePath();
      ctx.fill();
      ctx.strokeStyle='#9ca3af'; ctx.stroke();
    });

    // pickups
    world.pickups.forEach(p => {
      if (p.type==='water') ctx.fillStyle = '#60a5fa';
      if (p.type==='food')  ctx.fillStyle = '#fbbf24';
      if (p.type==='sleep') ctx.fillStyle = '#a78bfa';
      ctx.beginPath(); ctx.arc(p.x*T, p.y*T, T*0.25, 0, Math.PI*2); ctx.fill();
    });

    // enemies
    world.enemies.forEach(e => {
      ctx.fillStyle = '#c2410c';
      ctx.beginPath(); ctx.arc(e.x*T, e.y*T, e.r*T, 0, Math.PI*2); ctx.fill();
      ctx.fillStyle = '#fff'; ctx.font = `${Math.floor(T*0.38)}px sans-serif`;
      ctx.fillText('üò†', e.x*T - T*0.28, e.y*T + T*0.15);
    });

    // player
    drawBeagle(world.player.x, world.player.y, world.player.r, world.player.anim, 1);

    // Dim overlay for night
    const night = timeOfDay<0.18 || timeOfDay>0.82 ? 1 : 0;
    if (night) {
      ctx.fillStyle = 'rgba(0,0,0,0.25)';
      ctx.fillRect(0,0,world.w*T, world.h*T);
    }

    ctx.restore();

    // Text overlay
    ctx.fillStyle = 'rgba(255,255,255,0.9)';
    ctx.font = '16px system-ui';
    ctx.fillText(`Cel: ${levels[round-1].needed} üßª  |  Zebrane: ${goalCollected}  |  Czas: ${Math.max(0,Math.ceil(timeLeft))}s`, 10, canvas.height-16);
  }

  function loop(now) {
    const dt = Math.min(0.033, (now - lastTime)/1000);
    lastTime = now;
    update(dt);
    render();
    requestAnimationFrame(loop);
  }

  // Init
  ui.coins.textContent = coins;
  ui.round.textContent = round;
  spawnLevel();
  requestAnimationFrame(loop);

  // Enable audio on first gesture (mobile)
  window.addEventListener('pointerdown', ensureAudio, {once:true});

  // Auto profile: if no active profile, create/use "Gosc"
  (function initProfile(){
    const existing = listProfiles();
    if (existing.length === 0) {
      const nick = 'Gosc';
      const arr = [nick];
      localStorage.setItem('leonek_profiles_v1', JSON.stringify({list:arr}));
      // seed a basic save so game starts
      localStorage.setItem('leonek_'+nick+'_save', JSON.stringify({
        coins: 0, round: 1,
        upgrades: { sprint:false, waterSlow:false, foodSlow:false, sleepSlow:false },
        meters: { water:100, food:100, sleep:100 },
        mood: 80, timeOfDay: 0.25, worldSeed: Math.random()*1e9|0
      }));
      useProfile(nick);
      setTimeout(()=>{ toast('Profil ‚ÄûGosc‚Äù utworzony. Zmie≈Ñ w ‚ÄûProfil‚Äù.'); }, 300);
    } else {
      useProfile(existing[0]);
      setTimeout(()=>{ toast('Wci≈õnij ‚ÄûProfil‚Äù aby zmieniƒá nick.'); }, 300);
    }
  })();
})();
</script>
</body>
</html>
